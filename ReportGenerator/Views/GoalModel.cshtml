@model ReportGenerator.ViewModel
@using KAOSTools.Core
@using ReportGenerator.Helpers
@using System.IO

@{
    Layout = "Layout.cshtml";
    ViewBag.Title = Model.Model.Title;
    ViewBag.Author = Model.Model.Author;
    ViewBag.Version = Model.Model.Version;
}

<div class="section-header">
<h1>Goals</h1>
</div>

<div class="subsection-header">
    <h2>Goal summary</h2>
</div>

  <ul>
  @foreach (var g in Model.Model.Goals().OrderBy (g => g.FriendlyName)) {
    <li><a href="#goal-@g.Identifier">@g.FriendlyName</a></li>
  }
  </ul>


<div class="subsection-header">
    <h2>Goal details</h2>
</div>
@{
  int dgraphID = 0;
}
    @foreach (var g in Model.Model.Goals()) {
      var isRoot = Model.Model.Goals().Count (x => x.Refinements().Count (y => Enumerable.Contains(y.SubGoalIdentifiers, g.Identifier)) > 0) == 0;
      var isResolvingGoal = Model.Model.Obstacles().Count (x => x.Resolutions().Count (y => y.ResolvingGoalIdentifier == g.Identifier) > 0) > 0;
      
      <h4 id="goal-@g.Identifier">
     
        @g.FriendlyName
        
        <span style="float: right">
        @if (g.Implicit) {
          <span class="label label-warning">Implicit</span>
        }
        
        @if (isRoot & !isResolvingGoal) {     
          <span class="label label-primary">Root goal</span>
        }
      
        @if (isResolvingGoal) {
          <span class="label label-success">Countermeasure goal</span>
        }
        </span>
      </h4>
      
      <table class="table table-striped table-bordered">
        @Identifier(g)
        @Name(g)
        @Definition(g)
        @FormalSpec(g)
      </table>
      
      <dl>
        @ParentGoals(g)
        @GoalRefinements(g)
        @GoalAgentAssignments(g)
        @GoalObstructions(g)
        @Resolutions(g)
        @Except(g)
        @Source(g)
      </dl>
      
      <div class="diagram" id="diagram-@g.Identifier">
        <div></div>
        <pre class="hidden"></pre>
        <p class="caption">Partial goal model for <em>@g.FriendlyName</em>. (<a href="#" class="code">Show JSON</a>)</p>
      </div>
      
      <script type="text/javascript">
      
        $(document).ready (function() {
            $("#diagram-@g.Identifier pre").text(JSON.stringify(@JSONHelper.GetPartialGoalDiagram(g), undefined, 2));
            $("#diagram-@g.Identifier p.caption a.code").click (function () {
                $("#diagram-@g.Identifier pre").toggleClass ('hidden');
                if ($("#diagram-@g.Identifier p.caption a.code").text() == "Show JSON") {
                    $("#diagram-@g.Identifier p.caption a.code").text("Hide JSON");
                } else {
                    $("#diagram-@g.Identifier p.caption a.code").text("Show JSON");
                }
                return false;
            });
            RenderGoalDiagram (@JSONHelper.GetPartialGoalDiagram(g), "#diagram-@g.Identifier div");
        });
        
        
      </script>
      
      <hr class="spacer" />
      
    }
    
@helper Identifier (dynamic item) {
  <tr>
    <th>Identifier</th>
    <td>
      <p><code>@item.Identifier</code></p>
    </td>
  </tr>
}

@helper Name (dynamic item) {
  <tr>
    <th>Name</th>
    <td>
      <p>@item.Name</p>
    </td>
  </tr>
}

@helper Definition (dynamic item) {
  <tr>
    <th>Definition</th>
    <td>
      @if (string.IsNullOrWhiteSpace(item.Definition)) {
        <span class="text-muted">Not provided</span>
      } else {
        @MarkdownHelper.CompileMarkdown(item.Definition)
      }
    </td>
  </tr>
}

@helper FormalSpec (dynamic item) {
  if (item.FormalSpec != null) {
    <tr>
      <th>Formal&nbsp;specification</th>
      <td>
        <div class="formalspec"></div>
      </td>
    </tr>
  }
}

@helper GoalRefinements (Goal g) {
  if (g.Refinements().Count() > 0) {
      <dt>Refined&nbsp;by</dt>
      <dd>
      @foreach (var r in g.Refinements()) {
        if (r.SystemReference() != null | g.Refinements().Count() > 1) {
          <p><strong>Alternative refinement</strong> @(r.SystemReference() != null ? "(" + r.SystemReference().FriendlyName + ")" : "")</p>
        }
        <ul>
          @foreach (var g2 in r.SubGoals()) {
            <li><a href="#@g2.Identifier">@g2.FriendlyName</a></li>
          }
          @foreach (var g2 in r.DomainProperties()) {
            <li><a href="#@g2.Identifier">@g2.FriendlyName</a></li>
          }
          @foreach (var g2 in r.DomainHypotheses()) {
            <li><a href="#@g2.Identifier">@g2.FriendlyName</a></li>
          }
        </ul>
      }
      </dd>
  }
}

@helper ParentGoals (dynamic g) {
  var parents = Model.Model.Goals().Where (x => x.Refinements().Count(y => Enumerable.Contains(y.SubGoalIdentifiers, g.Identifier)) > 0);
  if (parents.Count() > 0) {
    <dt>@if (parents.Count() > 1) {
      @:Parent goals
    } else {
      @:Parent goal
    }</dt>
    <dd><ul>
      @foreach (var o in parents) {
        <li><a href="#@o.Identifier">@o.FriendlyName</a></li>
      }
    </ul></dd>
  }
}

@helper Except (Goal g) {
  var e = g.Exceptions();
  if (e.Count() > 0) {
    <dt>Exceptions</dt>
    <dd><ul>
      @foreach (var o in e) {
        <li><a href="#@o.ResolvedObstacleIdentifier">@o.Obstacle().FriendlyName</a> 
          <strong>then</strong> @o.ResolvingGoal().FriendlyName</li>
      }
    </ul>
    </dd>
  }
}

@helper GoalAgentAssignments (Goal g) {
  if (g.AgentAssignments().Count() > 0) {
      <dt>Assigned&nbsp;to</dt>
      <dd>
        @foreach (var r in g.AgentAssignments()) {
          if (g.AgentAssignments().Count() > 1) {
            <p>
              <strong>Alternative assignment</strong> 
              @(r.SystemReference != null ? "(" + r.SystemReference.FriendlyName + ")" : "")
     
              @{
                var isRequirement = ((IEnumerable<Agent>) r.Agents()).All (y => y.Type == KAOSTools.Core.AgentType.Software);
                var isExpectation = ((IEnumerable<Agent>) r.Agents()).All (y => y.Type == KAOSTools.Core.AgentType.Environment | y.Type == KAOSTools.Core.AgentType.None);
              }
              
              @if (isRequirement) {
                <span class="label label-important">Requirement</span>
              }
              
              @if (isExpectation) {
                <span class="label label-success">Expectation</span>
              }
            </p>
          }
          <ul>
            @foreach (var a in r.Agents()) {
              <li><a href="#@a.Identifier">@a.FriendlyName</a></li>
            }
          </ul>
        }
      </dd>
  }
}


@helper GoalObstructions (Goal g) {
  if (g.Obstructions().Count() > 0) {
    <dt>Obstructed&nbsp;by</dt>
    <dd><ul>
      @foreach (var o in g.Obstructions()) {
        <li><a href="#@o.Obstacle().Identifier">@o.Obstacle().FriendlyName</a></li>
      }
    </ul></dd>
  }
}


@helper Resolutions (Goal g) {
  if (g.Resolutions().Count() > 0) {
    <dt>Resolving</dt>
    <dd><ul>
      @foreach (var o in g.Resolutions()) {
        <li><a href="#@o.Obstacle().Identifier">@o.Obstacle().FriendlyName</a></li>
      }
    </ul></dd>
  }
}

@helper Source (KAOSCoreElement g) {
  if (Model.Declarations.ContainsKey(g)) {
    <dt>Defined in</dt>
    <dd><ul>
      @foreach (var o in Model.Declarations[g]) {
        <li><code>@o.Filename</code> at line <code>@o.Line</code>, column <code>@o.Col</code></li>
      }
    </ul></dd>
  }
}